uwsgi_cache_path /var/cache/nginx/feeds keys_zone=feeds_cache:10m max_size=10g
                 inactive=10m use_temp_path=off;
limit_req_zone $binary_remote_addr zone=adminlimit:10m rate=5r/m;

server {
    listen 80;
    server_name localhost;

    server_tokens off;

    location /favicon.ico {
        alias /var/www/static/favicon.ico;
        access_log off;
        log_not_found off;
    }

    location /static/ {
        alias /var/www/static/;
    }

    location ~^/(admin|api|gui) {
        proxy_set_header        X-Forwarded-Proto https;
        proxy_set_header        X-Url-Scheme $scheme;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        Host $http_host;
        proxy_redirect          off;
        proxy_pass              http://uwsgi:8001;
        client_max_body_size    100m;
    }

    location ^~/admin {
        limit_req zone=adminlimit;

        proxy_set_header        X-Forwarded-Proto https;
        proxy_set_header        X-Url-Scheme $scheme;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        Host $http_host;
        proxy_redirect          off;
        proxy_pass              http://uwsgi:8001;
        client_max_body_size    100m;
    }

    location ~^/api/feeds {
        limit_req zone=adminlimit;
        proxy_set_header        X-Forwarded-Proto https;
        proxy_set_header        X-Url-Scheme $scheme;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        Host $http_host;
        proxy_redirect          off;
        proxy_pass              http://uwsgi:8001;
        client_max_body_size    100m;

        gzip on;
        gzip_types application/json;
        gzip_min_length 1000;

        uwsgi_cache feeds_cache;
        uwsgi_cache_key $scheme$host$uri$is_args$args;
        uwsgi_cache_valid 200 10m;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # All requests to the Django/UWSGI server.
    location / {
        proxy_set_header        X-Forwarded-Proto https;
        proxy_set_header        X-Url-Scheme $scheme;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        Host $http_host;
        proxy_redirect          off;
        proxy_pass              http://uwsgi:8001;
        client_max_body_size    100m;
    }

}
